<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Quill Editor CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      margin-top: 0;
      padding-top: 0;
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .dashboard-layout {
      display: flex;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      margin-top: 0;
      padding-top: 0;
    }

    .dashboard-main {
      flex: 1;
      padding: 0.25rem 2.5rem 2rem 2.5rem;
      margin-left: 280px;
      background: #f9fafb;
      margin-top: 0;
      padding-top: 0.25rem;
    }

    .page-header {
      margin-bottom: 2rem;
      margin-top: 0;
      padding-top: 0;
      animation: fadeInUp 0.6s ease-out 0.1s both;
    }

    .page-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 0.5rem;
    }

    .page-header p {
      color: #6b7280;
      font-size: 0.9375rem;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      color: #6b7280;
      font-size: 0.875rem;
      animation: fadeIn 0.5s ease-out;
    }

    .breadcrumb a {
      color: #c51d34;
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .form-container {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
      padding: 2rem;
      max-width: 1000px;
      margin: 0 auto;
      animation: fadeInUp 0.6s ease-out 0.3s both;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    .form-group {
      margin-bottom: 2rem;
      animation: fadeInUp 0.5s ease-out both;
    }

    .form-group:nth-child(1) { animation-delay: 0.4s; }
    .form-group:nth-child(2) { animation-delay: 0.45s; }
    .form-group:nth-child(3) { animation-delay: 0.5s; }
    .form-group:nth-child(4) { animation-delay: 0.55s; }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group.full-width.section-separator {
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 2px solid #e5e7eb;
    }

    .form-container .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #111827 !important;
      opacity: 1 !important;
    }

    .form-container .form-group label .required {
      color: #c51d34;
    }

    .form-container .form-control,
    .form-container input.form-control,
    .form-container select.form-control,
    .form-container textarea.form-control {
      width: 100% !important;
      padding: 0.75rem !important;
      border: 2px solid #e5e7eb !important;
      border-radius: 6px !important;
      font-size: 0.875rem !important;
      font-family: inherit !important;
      background: #ffffff !important;
      color: #111827 !important;
      box-sizing: border-box !important;
      transition: all 0.2s ease !important;
      opacity: 1 !important;
      visibility: visible !important;
      display: block !important;
    }

    .form-container textarea.form-control {
      min-height: 200px;
      resize: vertical;
    }

    /* Ensure hidden textarea is never visible */
    #content[style*="display: none"],
    textarea#content {
      display: none !important;
      visibility: hidden !important;
      position: absolute !important;
      width: 0 !important;
      height: 0 !important;
      opacity: 0 !important;
      pointer-events: none !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
    }

    /* Quill Editor Styles */
    #editor-container {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: #ffffff;
      margin-top: 0.5rem;
      overflow: visible;
      transition: all 0.2s ease;
      position: relative;
    }

    #editor-container .ql-editor {
      min-height: 400px;
      font-size: 0.9375rem;
      font-family: inherit;
      color: #111827;
      line-height: 1.6;
      padding: 1.25rem;
      overflow: visible;
    }

    #editor-container .ql-toolbar {
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      border-bottom: 2px solid #e5e7eb;
      background: #f9fafb;
      padding: 0.75rem;
    }

    #editor-container .ql-container {
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      font-family: inherit;
      border: none;
      position: relative;
      overflow: visible;
    }

    #editor-container .ql-editor.ql-blank::before {
      color: #9ca3af;
      font-style: normal;
      left: 1.25rem;
    }

    #editor-container .ql-editor:focus {
      outline: none;
    }

    #editor-container:focus-within {
      border-color: #c51d34;
      box-shadow: 0 0 0 3px rgba(197, 29, 52, 0.1);
    }

    /* Fix Quill tooltip positioning */
    .ql-tooltip {
      position: absolute !important;
      z-index: 1000;
      white-space: nowrap;
    }

    .ql-tooltip.ql-editing {
      left: 0 !important;
      margin-top: 8px;
    }

    /* Ensure tooltip stays within editor bounds */
    #editor-container .ql-tooltip {
      max-width: calc(100% - 2rem);
      left: 1rem !important;
      transform: none !important;
    }

    /* Disable image handler in Quill */
    #editor-container .ql-toolbar .ql-image,
    #editor-container .ql-toolbar .ql-video {
      display: none !important;
    }

    .form-container .form-control:focus,
    .form-container input.form-control:focus,
    .form-container select.form-control:focus,
    .form-container textarea.form-control:focus {
      outline: none !important;
      border-color: #c51d34 !important;
      box-shadow: 0 0 0 3px rgba(197, 29, 52, 0.1) !important;
      transform: none !important;
      opacity: 1 !important;
    }

    .form-help {
      display: block;
      margin-top: 0.25rem;
      font-size: 0.8125rem;
      color: #6b7280;
      opacity: 1 !important;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0;
    }

    .form-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #c51d34;
      margin: 0;
      flex-shrink: 0;
    }

    .form-checkbox label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
      color: #111827;
      opacity: 1 !important;
    }

    .form-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid #e5e7eb;
      animation: fadeInUp 0.5s ease-out 1s both;
    }

    .form-container .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      opacity: 1 !important;
      width: auto;
      min-width: 44px;
      min-height: 44px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      white-space: nowrap;
    }
    
    .form-container .btn .btn-text {
      display: inline-block;
    }
    
    @media (max-width: 640px) {
      .form-container .btn .btn-text {
        display: none;
      }
      .form-container .btn {
        width: 44px;
        height: 44px;
        padding: 0.5rem;
        min-width: 44px;
      }
    }

    .form-container .btn-primary {
      background: linear-gradient(135deg, #c51d34 0%, #a01628 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(197, 29, 52, 0.3);
    }

    .form-container .btn-primary:hover {
      background: linear-gradient(135deg, #a01628 0%, #8a1323 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(197, 29, 52, 0.4);
    }

    .form-container .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }

    .form-container .btn-secondary:hover {
      background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
    }

    .form-container .btn-submit {
      background: linear-gradient(135deg, #c51d34 0%, #a01628 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(197, 29, 52, 0.3);
      width: auto;
      padding: 0.75rem 1.5rem;
    }

    .form-container .btn-submit:hover {
      background: linear-gradient(135deg, #a01628 0%, #8a1323 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(197, 29, 52, 0.4);
    }

    /* Image Upload Styles */
    .image-upload-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .existing-images-container {
      margin-bottom: 1rem;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .image-item {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.2s;
    }

    .image-item.selected {
      border-color: #c51d34;
      box-shadow: 0 0 0 3px rgba(197, 29, 52, 0.2);
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-checkbox {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      width: 24px;
      height: 24px;
      cursor: pointer;
      accent-color: #c51d34;
      z-index: 10;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .image-actions {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.5rem;
    }

    .cover-image-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(107, 114, 128, 0.9);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .cover-image-btn:hover {
      background: rgba(75, 85, 99, 1);
      transform: scale(1.1);
    }

    .cover-image-btn.active {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4);
    }

    .cover-image-btn.active:hover {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .remove-image-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .remove-image-btn:hover {
      background: rgba(220, 38, 38, 1);
      transform: scale(1.1);
    }

    .bulk-delete-container {
      margin-top: 1rem;
      padding: 1rem;
      background: #fef2f2;
      border: 2px solid #fee2e2;
      border-radius: 8px;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .bulk-delete-container.show {
      display: flex;
    }

    .bulk-delete-info {
      font-size: 0.875rem;
      color: #111827;
      font-weight: 500;
    }

    .bulk-delete-btn {
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .bulk-delete-btn:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .image-upload-input {
      display: none;
    }

    /* Drag and Drop Styles */
    .image-upload-dropzone {
      position: relative;
      min-height: 120px;
      border: 2px dashed #e5e7eb;
      border-radius: 8px;
      padding: 1.5rem;
      background: #f9fafb;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .image-upload-dropzone:hover {
      border-color: #c51d34;
      background: #fef2f2;
      transform: scale(1.02);
      box-shadow: 0 0 0 4px rgba(197, 29, 52, 0.1),
                  0 4px 20px rgba(197, 29, 52, 0.3),
                  0 8px 30px rgba(197, 29, 52, 0.2),
                  inset 0 0 20px rgba(197, 29, 52, 0.05);
      animation: dragGlow 1.5s ease-in-out infinite;
    }

    .image-upload-dropzone.drag-over {
      border-color: #c51d34;
      background: #fef2f2;
      transform: scale(1.02);
      box-shadow: 0 0 0 4px rgba(197, 29, 52, 0.1),
                  0 4px 20px rgba(197, 29, 52, 0.3),
                  0 8px 30px rgba(197, 29, 52, 0.2),
                  inset 0 0 20px rgba(197, 29, 52, 0.05);
      animation: dragGlow 1.5s ease-in-out infinite;
    }

    @keyframes dragGlow {
      0%, 100% {
        box-shadow: 0 0 0 4px rgba(197, 29, 52, 0.1),
                    0 4px 20px rgba(197, 29, 52, 0.3),
                    0 8px 30px rgba(197, 29, 52, 0.2),
                    inset 0 0 20px rgba(197, 29, 52, 0.05);
      }
      50% {
        box-shadow: 0 0 0 6px rgba(197, 29, 52, 0.15),
                    0 4px 25px rgba(197, 29, 52, 0.4),
                    0 10px 40px rgba(197, 29, 52, 0.3),
                    inset 0 0 25px rgba(197, 29, 52, 0.08);
      }
    }

    .image-upload-dropzone:hover .dropzone-content,
    .image-upload-dropzone.drag-over .dropzone-content {
      opacity: 1;
    }

    .image-upload-dropzone:hover .dropzone-text {
      color: #c51d34;
    }

    .dropzone-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      text-align: center;
      transition: opacity 0.3s ease;
    }

    .dropzone-icon {
      font-size: 2.5rem;
      color: #c51d34;
      margin-bottom: 0.5rem;
    }

    .dropzone-text {
      font-size: 0.9375rem;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }

    .dropzone-hint {
      font-size: 0.8125rem;
      color: #6b7280;
      margin: 0;
    }

    .dropzone-or {
      font-size: 0.75rem;
      color: #9ca3af;
      margin: 0.5rem 0;
      font-weight: 500;
    }

    .image-upload-btn {
      padding: 0.5rem 1rem;
      background: #f9fafb;
      border: 2px dashed #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      font-size: 0.875rem;
      color: #6b7280;
      transition: all 0.2s;
      position: relative;
    }

    .image-upload-btn:hover {
      border-color: #c51d34;
      background: #fef2f2;
      color: #c51d34;
    }

    /* Links Container */
    .links-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      background: #f9fafb;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      margin-top: 1rem;
    }

    .link-item {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 0.75rem;
      align-items: center;
      background: white;
      padding: 0.75rem;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }

    .link-item input {
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      font-size: 0.875rem;
      width: 100%;
      box-sizing: border-box;
    }

    .link-remove-btn {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .link-remove-btn:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
    }

    .link-add-btn {
      padding: 0.75rem 1.5rem;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      transition: all 0.2s;
    }

    .link-add-btn:hover {
      background: #059669;
      transform: translateY(-1px);
    }

    /* Success/Error/Confirmation Modal Styles */
    .success-modal,
    .confirmation-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .success-modal.show,
    .confirmation-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content-wrapper {
      background: white;
      border-radius: 16px;
      padding: 2.5rem;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.8);
      transition: transform 0.3s ease;
      text-align: center;
    }

    .success-modal.show .modal-content-wrapper,
    .confirmation-modal.show .modal-content-wrapper {
      transform: scale(1);
    }

    .modal-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      animation: successPulse 0.6s ease-out;
    }

    .modal-icon.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .modal-icon.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .modal-icon i {
      color: white;
      font-size: 2.5rem;
    }

    @keyframes successPulse {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modal-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 0.75rem;
    }

    .modal-message {
      color: #6b7280;
      font-size: 1rem;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .modal-btn {
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-size: 0.9375rem;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #c51d34 0%, #a01628 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(197, 29, 52, 0.3);
    }

    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(197, 29, 52, 0.4);
    }

    .modal-btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .modal-btn-secondary:hover {
      background: #e5e7eb;
    }

    @media (max-width: 768px) {
      .dashboard-main {
        margin-left: 0;
        padding: 1rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .link-item {
        grid-template-columns: 1fr;
      }
      
      .form-actions {
        flex-direction: column-reverse;
        gap: 0.75rem;
      }
      
      .form-actions .btn {
        width: 100%;
        justify-content: center;
      }
      
      .form-actions .btn .btn-text {
        display: inline-block;
      }
    }
    
    @media (max-width: 480px) {
      .form-container {
        padding: 1.5rem;
      }
      
      .form-actions .btn {
        font-size: 0.8125rem;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-layout">
    <%- include('../partials/admin-sidebar') %>
    
    <div class="dashboard-main">
      <div class="breadcrumb">
        <a href="/admin/dashboard">Dashboard</a>
        <i class="fas fa-chevron-right"></i>
        <a href="/admin/activities/blogs">Blogs</a>
        <i class="fas fa-chevron-right"></i>
        <span><%= isEdit ? 'Edit' : 'Add' %> Blog</span>
      </div>

      <div class="page-header">
        <h1><%= isEdit ? 'Edit' : 'Add' %> Blog</h1>
        <p><%= isEdit ? 'Update blog post' : 'Create a new blog post' %></p>
      </div>

      <div class="form-container">
        <form method="POST" action="<%= isEdit ? `/admin/activities/blogs/${blog.id}` : '/admin/activities/blogs/add' %>" id="blogForm" enctype="multipart/form-data">
          <div class="form-grid">
            <!-- Title -->
            <div class="form-group">
              <label for="title">Title <span class="required">*</span></label>
              <input type="text" id="title" name="title" class="form-control" required placeholder="Blog Post Title" value="<%= isEdit && blog ? (blog.title || '') : '' %>">
            </div>

            <!-- Slug -->
            <div class="form-group">
              <label for="slug">Slug <span class="required">*</span></label>
              <input type="text" id="slug" name="slug" class="form-control" required placeholder="blog-post-title" value="<%= isEdit && blog ? (blog.slug || '') : '' %>">
              <small class="form-help">URL-friendly identifier (auto-generated from title if left empty)</small>
            </div>

            <!-- Content -->
            <div class="form-group full-width">
              <label for="content">Content <span class="required">*</span></label>
              <div id="editor-container" style="min-height: 400px; margin-bottom: 0.5rem;"></div>
              <textarea id="content" name="content" class="form-control" required placeholder="Write your blog content here..." style="display: none !important; visibility: hidden !important; position: absolute !important; width: 0 !important; height: 0 !important; opacity: 0 !important; pointer-events: none !important;" aria-hidden="true" tabindex="-1"><%= isEdit && blog ? (blog.content || '') : '' %></textarea>
              <small class="form-help">Main content of your blog post with rich text formatting (text, headings, lists, links, etc.)</small>
            </div>

            <!-- Blog Images (Multiple) -->
            <div class="form-group full-width" style="margin-top: 4rem; padding-top: 3rem; border-top: 1px solid #e5e7eb;">
              <label>Blog Images</label>
              <small class="form-help">Recommended image size: <strong>1200px × 800px</strong> for optimal display quality</small>
              <div class="image-upload-container">
                <!-- Existing Images -->
                <div id="existingImagesContainer" class="existing-images-container">
                  <% 
                    let existingImages = [];
                    if (isEdit && blog && blog.images && Array.isArray(blog.images)) {
                      existingImages = blog.images.map(img => {

                        if (typeof img === 'object' && img.filename && img.path) {
                          return img;
                        }

                        if (typeof img === 'string') {
                          return {
                            filename: img.split('/').pop(),
                            path: img
                          };
                        }

                        return {
                          filename: String(img).split('/').pop(),
                          path: String(img)
                        };
                      });
                    }
                  %>
                  <% if (existingImages.length > 0) { %>
                    <div class="images-grid" id="existingImagesGrid">
                      <% existingImages.forEach((img, index) => { %>
                        <div class="image-item" data-image-filename="<%= img.filename %>" data-image-path="<%= img.path %>">
                          <input type="checkbox" class="image-checkbox" data-image-path="<%= img.path %>" onchange="toggleImageSelection(this)">
                          <img src="<%= img.path %>" alt="Blog Image" onerror="this.parentElement.remove();">
                          <div class="image-actions">
                            <% 
                              const isCoverImage = blog.cover_image && (blog.cover_image.includes(img.filename) || blog.cover_image === img.path);
                            %>
                            <button type="button" class="cover-image-btn <%= isCoverImage ? 'active' : '' %>" 
                                    onclick="setCoverImage('<%= img.path %>', this)" 
                                    title="<%= isCoverImage ? 'Cover Image' : 'Set as Cover Image' %>">
                              <i class="<%= isCoverImage ? 'fas' : 'far' %> fa-star"></i>
                            </button>
                            <button type="button" class="remove-image-btn" onclick="removeExistingImage('<%= img.path %>', this)" title="Remove Image">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                          <input type="hidden" name="existing_images[]" value="<%= img.path %>">
                        </div>
                      <% }) %>
                    </div>
                    <div class="bulk-delete-container" id="bulkDeleteContainer">
                      <span class="bulk-delete-info" id="bulkDeleteInfo">0 images selected</span>
                      <button type="button" class="bulk-delete-btn" onclick="deleteSelectedImages()">
                        <i class="fas fa-trash"></i> Delete Selected
                      </button>
                    </div>
                  <% } %>
                </div>
                
                <!-- Cover Image Input (always present) -->
                <input type="hidden" name="cover_image" id="coverImageInput" value="<%= isEdit && blog ? (blog.cover_image || '') : '' %>">
                
                <!-- New Images Upload -->
                <div class="new-images-upload">
                  <div class="image-upload-dropzone" id="imageUploadDropzone">
                    <div class="dropzone-content">
                      <i class="fas fa-cloud-upload-alt dropzone-icon"></i>
                      <p class="dropzone-text">Drag & drop your blog images here</p>
                      <p class="dropzone-hint">or</p>
                      <label for="images" class="image-upload-btn">
                        <i class="fas fa-upload"></i> Choose Blog Images (Multiple)
                      </label>
                      <input type="file" id="images" name="images" class="image-upload-input" accept="image/*" multiple>
                      <p class="dropzone-hint" style="margin-top: 0.5rem;">PNG, JPG, WEBP - max 5MB each, up to 10 images</p>
                      <p class="dropzone-hint" style="margin-top: 0.25rem; font-weight: 600; color: #c51d34;">Recommended size: 1200px × 800px</p>
                    </div>
                  </div>
                  
                  <!-- Preview for new images -->
                  <div id="newImagesPreview" class="images-grid" style="margin-top: 1rem; display: none;"></div>
                  <div class="bulk-delete-container" id="bulkDeleteNewContainer" style="margin-top: 1rem;">
                    <span class="bulk-delete-info" id="bulkDeleteNewInfo">0 images selected</span>
                    <button type="button" class="bulk-delete-btn" onclick="deleteSelectedNewImages()">
                      <i class="fas fa-trash"></i> Delete Selected
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Blog Video URL -->
            <div class="form-group full-width" style="margin-bottom: 1rem;">
              <label for="video_url">Blog Video URL</label>
              <input type="url" id="video_url" name="video_url" class="form-control" placeholder="https://www.youtube.com/watch?v=..." value="<%= isEdit && blog ? (blog.video_url || '') : '' %>">
              <small class="form-help">Paste a video link (YouTube, Vimeo, or any video URL)</small>
            </div>

            <!-- Links -->
            <div class="form-group full-width" style="margin-top: 0;">
              <label>Links</label>
              <div class="links-container" id="linksContainer">
                <% 
                  let linksArray = [];
                  if (isEdit && blog && blog.links && blog.links.length > 0) {
                    linksArray = blog.links;
                  }
                  if (linksArray.length > 0) {
                    linksArray.forEach((link, index) => {
                      const linkText = typeof link === 'object' ? (link.text || link.url || '') : '';
                      const linkUrl = typeof link === 'object' ? (link.url || '') : link;
                %>
                  <div class="link-item">
                    <input type="text" name="links[<%= index %>][text]" placeholder="Link Text" value="<%= linkText %>" class="link-text-input">
                    <input type="url" name="links[<%= index %>][url]" placeholder="https://example.com" value="<%= linkUrl %>" class="link-url-input">
                    <button type="button" class="link-remove-btn" onclick="removeLink(this)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                <% 
                    });
                  } else {
                %>
                  <div class="link-item">
                    <input type="text" name="links[0][text]" placeholder="Link Text" class="link-text-input">
                    <input type="url" name="links[0][url]" placeholder="https://example.com" class="link-url-input">
                    <button type="button" class="link-remove-btn" onclick="removeLink(this)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                <% } %>
              </div>
              <button type="button" class="link-add-btn" onclick="addLink()">
                <i class="fas fa-plus"></i> Add Link
              </button>
            </div>

            <!-- Published Status -->
            <div class="form-group full-width">
              <div class="form-checkbox">
                <input type="checkbox" id="is_published" name="is_published" value="true" <%= isEdit && blog && blog.is_published ? 'checked' : '' %>>
                <label for="is_published">Publish this blog post</label>
              </div>
              <small class="form-help">Unpublished blogs are saved as drafts</small>
            </div>
          </div>

          <div class="form-actions">
            <a href="/admin/activities/blogs" class="btn btn-secondary" title="Cancel">
              <i class="fas fa-times"></i>
              <span class="btn-text">Cancel</span>
            </a>
            <button type="submit" class="btn btn-submit" id="submitBtn" title="<%= isEdit ? 'Update' : 'Create' %> Blog">
              <i class="fas fa-<%= isEdit ? 'save' : 'plus' %>"></i> <%= isEdit ? 'Update' : 'Create' %> Blog
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="success-modal" id="successModal">
    <div class="modal-content-wrapper">
      <div class="modal-icon">
        <i class="fas fa-check"></i>
      </div>
      <h3 class="modal-title"><%= isEdit ? 'Blog Updated!' : 'Blog Created!' %></h3>
      <p class="modal-message"><%= isEdit ? 'The blog has been successfully updated.' : 'The blog has been successfully added to the system.' %></p>
      <div class="modal-actions">
        <a href="/admin/activities/blogs" class="modal-btn modal-btn-secondary">View Blogs</a>
        <% if (!isEdit) { %>
        <a href="/admin/activities/blogs/add" class="modal-btn modal-btn-primary">Add Another</a>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div class="success-modal" id="errorModal">
    <div class="modal-content-wrapper">
      <div class="modal-icon error">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3 class="modal-title">Error Occurred</h3>
      <p class="modal-message" id="errorMessage">Something went wrong. Please try again.</p>
      <div class="modal-actions">
        <button onclick="closeModal('errorModal')" class="modal-btn modal-btn-primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="confirmation-modal" id="confirmationModal">
    <div class="modal-content-wrapper">
      <div class="modal-icon warning">
        <i class="fas fa-question-circle"></i>
      </div>
      <h3 class="modal-title">Confirm Action</h3>
      <p class="modal-message" id="confirmationMessage">Are you sure you want to proceed?</p>
      <div class="modal-actions">
        <button onclick="closeModal('confirmationModal')" class="modal-btn modal-btn-secondary">Cancel</button>
        <button id="confirmBtn" class="modal-btn modal-btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Quill Editor JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>

    let quill;
    document.addEventListener('DOMContentLoaded', function() {
      const editorContainer = document.getElementById('editor-container');
      const contentTextarea = document.getElementById('content');
      
      if (editorContainer && contentTextarea) {
        quill = new Quill('#editor-container', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
              ['bold', 'italic', 'underline', 'strike'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'script': 'sub'}, { 'script': 'super' }],
              [{ 'indent': '-1'}, { 'indent': '+1' }],
              [{ 'direction': 'rtl' }],
              [{ 'size': ['small', false, 'large', 'huge'] }],
              [{ 'color': [] }, { 'background': [] }],
              [{ 'font': [] }],
              [{ 'align': [] }],
              ['clean'],
              ['link']
            ]
          },
          placeholder: 'Write your blog content here...'
        });


        if (contentTextarea) {
          contentTextarea.style.display = 'none';
          contentTextarea.style.visibility = 'hidden';
          contentTextarea.style.position = 'absolute';
          contentTextarea.style.width = '0';
          contentTextarea.style.height = '0';
          contentTextarea.style.opacity = '0';
          contentTextarea.style.pointerEvents = 'none';
          contentTextarea.setAttribute('aria-hidden', 'true');
          contentTextarea.setAttribute('tabindex', '-1');
        }


        const initialContent = contentTextarea ? contentTextarea.value : '';
        if (initialContent) {
          try {

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = initialContent;

            if (tempDiv.innerHTML !== initialContent || initialContent.includes('<')) {
              quill.root.innerHTML = initialContent;
            } else {

              const htmlContent = initialContent.replace(/\n/g, '<br>');
              quill.root.innerHTML = htmlContent;
            }
          } catch (e) {
            quill.root.innerHTML = initialContent.replace(/\n/g, '<br>');
          }
        }


        quill.on('text-change', function() {
          contentTextarea.value = quill.root.innerHTML;
        });


        quill.on('selection-change', function() {
          contentTextarea.value = quill.root.innerHTML;
        });


        quill.clipboard.addMatcher(Node.ELEMENT_NODE, function(node, delta) {
          if (node.tagName === 'IMG') {

            const Delta = Quill.import('delta');
            return new Delta().retain(delta.length());
          }
          return delta;
        });


        quill.root.addEventListener('paste', function(e) {
          const items = e.clipboardData.items;
          for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
              e.preventDefault();
              const errorMessageEl = document.getElementById('errorMessage');
              if (errorMessageEl) {
                errorMessageEl.textContent = 'Please use the Blog Images section below to upload images. Images cannot be inserted directly in the content editor.';
              }
              showModal('errorModal');
              return false;
            }
          }
        });
      }
    });

    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('show');
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('show');
      }
    }

    function showConfirmation(message, onConfirm) {
      const modal = document.getElementById('confirmationModal');
      const messageEl = document.getElementById('confirmationMessage');
      const confirmBtn = document.getElementById('confirmBtn');
      
      if (modal && messageEl) {
        messageEl.textContent = message;
        modal.classList.add('show');
        

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        newConfirmBtn.onclick = function() {
          closeModal('confirmationModal');
          if (onConfirm) onConfirm();
        };
      }
    }


    window.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const isEditMode = <%= JSON.stringify(isEdit) %>;
      
      if (urlParams.get('success') === 'true') {
        showModal('successModal');
        

        if (!isEditMode) {
          setTimeout(function() {
            const form = document.getElementById('blogForm');
            if (form) {
              form.reset();

              const newImagesPreview = document.getElementById('newImagesPreview');
              if (newImagesPreview) {
                newImagesPreview.innerHTML = '';
                newImagesPreview.style.display = 'none';
              }
            }
          }, 100);
        }
      } else if (urlParams.get('error') === 'true') {
        const errorMsg = decodeURIComponent(urlParams.get('message') || 'Something went wrong. Please try again.');
        document.getElementById('errorMessage').textContent = errorMsg;
        showModal('errorModal');
      }
      

      const linkItems = document.querySelectorAll('.link-item');
      linkItems.forEach(item => {
        const textInput = item.querySelector('.link-text-input');
        const urlInput = item.querySelector('.link-url-input');
        
        if (textInput && urlInput) {
          textInput.addEventListener('input', function() {
            validateLinkPair(textInput, urlInput);
          });
          
          urlInput.addEventListener('input', function() {
            validateLinkPair(textInput, urlInput);
          });
        }
      });
    });


    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('success-modal') || e.target.classList.contains('confirmation-modal')) {
        closeModal(e.target.id);
      }
    });


    document.getElementById('title')?.addEventListener('input', function() {
      const slugInput = document.getElementById('slug');
      if (slugInput && !slugInput.dataset.manualEdit) {
        const slug = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        slugInput.value = slug;
      }
    });


    document.getElementById('slug')?.addEventListener('input', function() {
      this.dataset.manualEdit = 'true';
    });


    const imagesInput = document.getElementById('images');
    const newImagesPreview = document.getElementById('newImagesPreview');
    const existingImagesGrid = document.getElementById('existingImagesGrid');
    const imageUploadDropzone = document.getElementById('imageUploadDropzone');
    const removedFileIndices = new Set();


    function processFiles(files) {
      if (!files || files.length === 0) return;

      const filesArray = Array.from(files);
      

      const existingCount = existingImagesGrid ? existingImagesGrid.children.length : 0;
      const newPreviewCount = newImagesPreview ? newImagesPreview.children.length : 0;
      const currentTotal = existingCount + newPreviewCount;
      
      if (filesArray.length + currentTotal > 10) {
        const errorMessageEl = document.getElementById('errorMessage');
        if (errorMessageEl) {
          errorMessageEl.textContent = `Maximum 10 images allowed. You currently have ${currentTotal} image(s). Please select fewer images.`;
        }
        showModal('errorModal');
        return;
      }


      const currentFileCount = imagesInput ? imagesInput.files.length : 0;
      let validFiles = [];


      filesArray.forEach((file, relativeIndex) => {

        if (file.size > 5 * 1024 * 1024) {
          const errorMessageEl = document.getElementById('errorMessage');
          if (errorMessageEl) {
            errorMessageEl.textContent = `Image "${file.name}" is too large. Maximum size is 5MB. Please select a smaller image.`;
          }
          showModal('errorModal');
          return;
        }


        if (!file.type.startsWith('image/')) {
          const errorMessageEl = document.getElementById('errorMessage');
          if (errorMessageEl) {
            errorMessageEl.textContent = `"${file.name}" is not an image file. Please select an image file.`;
          }
          showModal('errorModal');
          return;
        }


        const currentCount = existingImagesGrid ? existingImagesGrid.children.length : 0;
        const previewCount = newImagesPreview ? newImagesPreview.children.length : 0;
        if (currentCount + previewCount >= 10) {
          const errorMessageEl = document.getElementById('errorMessage');
          if (errorMessageEl) {
            errorMessageEl.textContent = 'Maximum 10 images allowed. Please remove some images first.';
          }
          showModal('errorModal');
          return;
        }

        validFiles.push(file);
        const index = currentFileCount + validFiles.length - 1;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';
          imageItem.dataset.fileName = file.name;
          imageItem.dataset.fileIndex = index;
          
          const previewId = `preview_${Date.now()}_${index}`;
          
          imageItem.innerHTML = `
            <input type="checkbox" class="image-checkbox" data-file-index="${index}" onchange="toggleImageSelection(this)">
            <img src="${e.target.result}" alt="Preview">
            <div class="image-actions">
              <button type="button" class="cover-image-btn" 
                      onclick="setCoverImageFromPreview(${index}, this)" 
                      title="Set as Cover Image">
                <i class="far fa-star"></i>
              </button>
              <button type="button" class="remove-image-btn" onclick="removeNewImage(this)" title="Remove Image">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
          imageItem.dataset.previewId = previewId;
          imageItem.dataset.fileIndex = index;
          
          if (!newImagesPreview) return;
          newImagesPreview.appendChild(imageItem);
          newImagesPreview.style.display = 'grid';
          

          const coverImageInput = document.getElementById('coverImageInput');
          if (coverImageInput && !coverImageInput.value && previewCount === 0 && validFiles.length === 1) {
            setCoverImageFromPreview(index, imageItem.querySelector('.cover-image-btn'));
          }
        };
        reader.readAsDataURL(file);
      });


      if (imagesInput && validFiles.length > 0) {
        const dataTransfer = new DataTransfer();
        const seenFiles = new Map(); 


        if (imagesInput.files) {
          for (let i = 0; i < imagesInput.files.length; i++) {
            const file = imagesInput.files[i];
            const fileKey = `${file.name}_${file.size}_${file.lastModified}`;
            if (!seenFiles.has(fileKey)) {
              seenFiles.set(fileKey, true);
              dataTransfer.items.add(file);
            }
          }
        }


        validFiles.forEach(file => {
          const fileKey = `${file.name}_${file.size}_${file.lastModified}`;
          if (!seenFiles.has(fileKey)) {
            seenFiles.set(fileKey, true);
            dataTransfer.items.add(file);
          }
        });
        
        imagesInput.files = dataTransfer.files;
      }
    }


    if (imagesInput) {
      imagesInput.addEventListener('change', function(e) {
        processFiles(e.target.files);
      });
    }


    if (imageUploadDropzone) {

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        imageUploadDropzone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }


      ['dragenter', 'dragover'].forEach(eventName => {
        imageUploadDropzone.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        imageUploadDropzone.addEventListener(eventName, unhighlight, false);
      });

      function highlight(e) {
        imageUploadDropzone.classList.add('drag-over');
      }

      function unhighlight(e) {
        imageUploadDropzone.classList.remove('drag-over');
      }


      imageUploadDropzone.addEventListener('drop', handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          processFiles(files);
        }
        
        imageUploadDropzone.classList.remove('drag-over');
      }
    }


    function setCoverImage(imagePath, button) {
      const coverImageInput = document.getElementById('coverImageInput');
      if (coverImageInput) {
        coverImageInput.value = imagePath;
      }


      document.querySelectorAll('#existingImagesGrid .cover-image-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.querySelector('i').className = 'far fa-star';
        btn.title = 'Set as Cover Image';
      });


      button.classList.add('active');
      button.querySelector('i').className = 'fas fa-star';
      button.title = 'Cover Image';
    }


    function setCoverImageFromPreview(fileIndex, button) {
      const coverImageInput = document.getElementById('coverImageInput');
      
      if (coverImageInput) {
        coverImageInput.value = `new_image_index_${fileIndex}`;
      }


      document.querySelectorAll('.cover-image-btn').forEach(btn => {
        btn.classList.remove('active');
        const icon = btn.querySelector('i');
        if (icon) {
          icon.className = 'far fa-star';
        }
        if (btn !== button) {
          btn.title = 'Set as Cover Image';
        }
      });


      button.classList.add('active');
      const icon = button.querySelector('i');
      if (icon) {
        icon.className = 'fas fa-star';
      }
      button.title = 'Cover Image';
    }


    function toggleImageSelection(checkbox) {
      const imageItem = checkbox.closest('.image-item');
      if (checkbox.checked) {
        imageItem.classList.add('selected');
      } else {
        imageItem.classList.remove('selected');
      }
      updateBulkDeleteUI();
    }

    function updateBulkDeleteUI() {

      const existingCheckboxes = document.querySelectorAll('#existingImagesGrid .image-checkbox:checked');
      const bulkDeleteContainer = document.getElementById('bulkDeleteContainer');
      const bulkDeleteInfo = document.getElementById('bulkDeleteInfo');
      
      if (bulkDeleteContainer && bulkDeleteInfo) {
        if (existingCheckboxes.length > 0) {
          bulkDeleteContainer.classList.add('show');
          bulkDeleteInfo.textContent = `${existingCheckboxes.length} image${existingCheckboxes.length > 1 ? 's' : ''} selected`;
        } else {
          bulkDeleteContainer.classList.remove('show');
        }
      }


      const newCheckboxes = document.querySelectorAll('#newImagesPreview .image-checkbox:checked');
      const bulkDeleteNewContainer = document.getElementById('bulkDeleteNewContainer');
      const bulkDeleteNewInfo = document.getElementById('bulkDeleteNewInfo');
      
      if (bulkDeleteNewContainer && bulkDeleteNewInfo) {
        if (newCheckboxes.length > 0) {
          bulkDeleteNewContainer.classList.add('show');
          bulkDeleteNewInfo.textContent = `${newCheckboxes.length} image${newCheckboxes.length > 1 ? 's' : ''} selected`;
        } else {
          bulkDeleteNewContainer.classList.remove('show');
        }
      }
    }

    function deleteSelectedImages() {
      const selectedCheckboxes = document.querySelectorAll('#existingImagesGrid .image-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
        return;
      }

      showConfirmation(`Are you sure you want to delete ${selectedCheckboxes.length} selected image${selectedCheckboxes.length > 1 ? 's' : ''}?`, function() {
        const coverImageInput = document.getElementById('coverImageInput');
        const blogForm = document.getElementById('blogForm');
        
        selectedCheckboxes.forEach(checkbox => {
          const imageItem = checkbox.closest('.image-item');
          const imagePath = imageItem ? imageItem.dataset.imagePath : checkbox.dataset.imagePath;
          
          if (coverImageInput && coverImageInput.value === imagePath) {
            coverImageInput.value = '';
          }

          const deleteInput = document.createElement('input');
          deleteInput.type = 'hidden';
          deleteInput.name = 'delete_images[]';
          deleteInput.value = imagePath;
          blogForm.appendChild(deleteInput);

          imageItem.remove();
        });

        if (existingImagesGrid && existingImagesGrid.children.length === 0) {
          existingImagesGrid.parentElement.style.display = 'none';
        }

        updateBulkDeleteUI();
      });
    }

    function deleteSelectedNewImages() {
      const selectedCheckboxes = document.querySelectorAll('#newImagesPreview .image-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
        return;
      }

      showConfirmation(`Are you sure you want to delete ${selectedCheckboxes.length} selected image${selectedCheckboxes.length > 1 ? 's' : ''}?`, function() {
        const coverImageInput = document.getElementById('coverImageInput');
        
        selectedCheckboxes.forEach(checkbox => {
          const imageItem = checkbox.closest('.image-item');
          const fileIndex = parseInt(checkbox.dataset.fileIndex);
          
          if (!isNaN(fileIndex)) {
            removedFileIndices.add(fileIndex);
          }

          if (coverImageInput && imageItem) {
            const currentCoverValue = coverImageInput.value;
            if (currentCoverValue && currentCoverValue.startsWith('new_image_index_')) {
              const coverIndex = parseInt(currentCoverValue.replace('new_image_index_', ''));
              if (coverIndex === fileIndex) {
                coverImageInput.value = '';
              }
            }
          }

          imageItem.remove();
        });


        const remainingImages = newImagesPreview.querySelectorAll('.image-item');
        if (remainingImages.length > 0 && coverImageInput && !coverImageInput.value) {
          const firstRemaining = remainingImages[0];
          const firstIndex = parseInt(firstRemaining.dataset.fileIndex);
          if (!isNaN(firstIndex) && !removedFileIndices.has(firstIndex)) {
            const firstCoverBtn = firstRemaining.querySelector('.cover-image-btn');
            if (firstCoverBtn) {
              setCoverImageFromPreview(firstIndex, firstCoverBtn);
            }
          }
        }

        if (newImagesPreview && newImagesPreview.children.length === 0) {
          newImagesPreview.style.display = 'none';
        }

        updateBulkDeleteUI();
      });
    }

    function removeExistingImage(filename, button) {
      showConfirmation('Are you sure you want to remove this image?', function() {
        const coverImageInput = document.getElementById('coverImageInput');
        const imageItem = button.closest('.image-item');
        const imagePath = imageItem ? imageItem.dataset.imagePath : null;
        
        if (coverImageInput && coverImageInput.value === imagePath) {
          coverImageInput.value = '';
        }

        const deleteInput = document.createElement('input');
        deleteInput.type = 'hidden';
        deleteInput.name = 'delete_images[]';
        deleteInput.value = imagePath || filename;
        document.getElementById('blogForm').appendChild(deleteInput);

        button.closest('.image-item').remove();

        if (existingImagesGrid && existingImagesGrid.children.length === 0) {
          existingImagesGrid.parentElement.style.display = 'none';
        }
        
        updateBulkDeleteUI();
      });
    }


    function removeNewImage(button) {
      const imageItem = button.closest('.image-item');
      const coverImageInput = document.getElementById('coverImageInput');
      

      const fileIndex = parseInt(imageItem.dataset.fileIndex);
      if (!isNaN(fileIndex)) {
        removedFileIndices.add(fileIndex);
      }
      

      if (coverImageInput && imageItem) {
        const currentCoverValue = coverImageInput.value;
        
        if (currentCoverValue && currentCoverValue.startsWith('new_image_index_')) {
          const coverIndex = parseInt(currentCoverValue.replace('new_image_index_', ''));
          if (coverIndex === fileIndex) {
            coverImageInput.value = '';
            

            const remainingImages = newImagesPreview.querySelectorAll('.image-item');
            if (remainingImages.length > 0) {
              const firstRemaining = remainingImages[0];
              const firstIndex = parseInt(firstRemaining.dataset.fileIndex);
              if (!isNaN(firstIndex) && !removedFileIndices.has(firstIndex)) {
                const firstCoverBtn = firstRemaining.querySelector('.cover-image-btn');
                if (firstCoverBtn) {
                  setCoverImageFromPreview(firstIndex, firstCoverBtn);
                }
              }
            }
          }
        }
      }
      
      imageItem.remove();
      

      if (newImagesPreview && newImagesPreview.children.length === 0) {
        newImagesPreview.style.display = 'none';
      }
      
      updateBulkDeleteUI();
    }


    function addLink() {
      const container = document.getElementById('linksContainer');
      const existingLinks = container.querySelectorAll('.link-item');
      const nextIndex = existingLinks.length;
      const linkItem = document.createElement('div');
      linkItem.className = 'link-item';
      linkItem.innerHTML = `
        <input type="text" name="links[${nextIndex}][text]" placeholder="Link Text" class="link-text-input">
        <input type="url" name="links[${nextIndex}][url]" placeholder="https://example.com" class="link-url-input">
        <button type="button" class="link-remove-btn" onclick="removeLink(this)">
          <i class="fas fa-trash"></i>
        </button>
      `;
      container.appendChild(linkItem);
      

      const textInput = linkItem.querySelector('.link-text-input');
      const urlInput = linkItem.querySelector('.link-url-input');
      
      textInput.addEventListener('input', function() {
        validateLinkPair(textInput, urlInput);
      });
      
      urlInput.addEventListener('input', function() {
        validateLinkPair(textInput, urlInput);
      });
    }

    function removeLink(btn) {
      btn.closest('.link-item').remove();
    }

    function validateLinkPair(textInput, urlInput) {
      const hasText = textInput.value.trim() !== '';
      const hasUrl = urlInput.value.trim() !== '';
      
      if (hasText && !hasUrl) {
        urlInput.setCustomValidity('URL is required when link text is provided');
      } else if (hasUrl && !hasText) {
        textInput.setCustomValidity('Link text is required when URL is provided');
      } else {
        textInput.setCustomValidity('');
        urlInput.setCustomValidity('');
      }
    }




    const CHUNK_SIZE = 750 * 1024; 
    const MAX_FILE_SIZE = 5 * 1024 * 1024; 


    const uploadedImageUrls = new Map(); 

    /**
     * Upload a file using chunked upload
     */
    async function uploadFileChunked(file, fileIndex) {
      return new Promise(async (resolve, reject) => {
        try {

          if (file.size > MAX_FILE_SIZE) {
            reject(new Error(`File "${file.name}" exceeds 5MB limit`));
            return;
          }


          const uploadIdResponse = await fetch('/admin/api/chunked-upload/upload-id');
          
          if (!uploadIdResponse.ok) {
            const errorText = await uploadIdResponse.text();
            reject(new Error(`Failed to get upload ID: ${uploadIdResponse.status} ${uploadIdResponse.statusText}. ${errorText.substring(0, 100)}`));
            return;
          }

          const contentType = uploadIdResponse.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            const errorText = await uploadIdResponse.text();
            reject(new Error(`Invalid response format. Expected JSON but got: ${contentType}. ${errorText.substring(0, 100)}`));
            return;
          }

          const uploadIdData = await uploadIdResponse.json();
          
          if (!uploadIdData.success) {
            reject(new Error(uploadIdData.message || 'Failed to get upload ID'));
            return;
          }

          const uploadId = uploadIdData.uploadId;
          const totalChunks = Math.ceil(file.size / CHUNK_SIZE);


          for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
            const start = chunkIndex * CHUNK_SIZE;
            const end = Math.min(start + CHUNK_SIZE, file.size);
            const chunk = file.slice(start, end);


            const chunkBase64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
              };
              reader.onerror = reject;
              reader.readAsDataURL(chunk);
            });


            const formData = new FormData();
            formData.append('uploadId', uploadId);
            formData.append('chunkIndex', chunkIndex);
            formData.append('totalChunks', totalChunks);
            formData.append('fileName', file.name);
            formData.append('fileSize', file.size);
            formData.append('chunkData', chunkBase64);

            const chunkResponse = await fetch('/admin/api/chunked-upload/chunk', {
              method: 'POST',
              body: formData
            });


            if (!chunkResponse.ok) {
              const errorText = await chunkResponse.text();
              reject(new Error(`Upload failed: ${chunkResponse.status} ${chunkResponse.statusText}. ${errorText.substring(0, 100)}`));
              return;
            }


            const contentType = chunkResponse.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
              const errorText = await chunkResponse.text();
              reject(new Error(`Invalid response format. Expected JSON but got: ${contentType}. ${errorText.substring(0, 100)}`));
              return;
            }

            const chunkResult = await chunkResponse.json();
            
            if (!chunkResult.success) {
              reject(new Error(chunkResult.message || 'Failed to upload chunk'));
              return;
            }

          }


          const completeFormData = new FormData();
          completeFormData.append('uploadId', uploadId);
          completeFormData.append('fileName', file.name);

          const completeResponse = await fetch('/admin/api/chunked-upload/complete', {
            method: 'POST',
            body: completeFormData
          });


          if (!completeResponse.ok) {
            const errorText = await completeResponse.text();
            reject(new Error(`Complete upload failed: ${completeResponse.status} ${completeResponse.statusText}. ${errorText.substring(0, 100)}`));
            return;
          }


          const completeContentType = completeResponse.headers.get('content-type');
          if (!completeContentType || !completeContentType.includes('application/json')) {
            const errorText = await completeResponse.text();
            reject(new Error(`Invalid response format. Expected JSON but got: ${completeContentType}. ${errorText.substring(0, 100)}`));
            return;
          }

          const completeResult = await completeResponse.json();
          
          if (!completeResult.success) {
            reject(new Error(completeResult.message || 'Failed to complete upload'));
            return;
          }

          resolve(completeResult.url);
        } catch (error) {
          reject(error);
        }
      });
    }

    /**
     * Upload all new images using chunked upload
     */
    async function uploadAllImages() {
      if (!imagesInput || !imagesInput.files) {
        return [];
      }

      const filesToUpload = [];
      const fileIndices = [];
      const seenFiles = new Map(); 


      for (let i = 0; i < imagesInput.files.length; i++) {
        if (!removedFileIndices.has(i)) {
          const file = imagesInput.files[i];

          const fileKey = `${file.name}_${file.size}_${file.lastModified}`;
          

          if (!seenFiles.has(fileKey)) {
            seenFiles.set(fileKey, i);
            filesToUpload.push(file);
            fileIndices.push(i);
          }
        }
      }

      if (filesToUpload.length === 0) {
        return [];
      }

      const uploadedUrls = [];
      

      for (let i = 0; i < filesToUpload.length; i++) {
        const file = filesToUpload[i];
        const originalIndex = fileIndices[i];
        
        try {
          const url = await uploadFileChunked(file, originalIndex);
          uploadedUrls.push(url);
          uploadedImageUrls.set(originalIndex, url);
        } catch (error) {
          console.error(`Error uploading ${file.name}:`, error);
          const errorMessageEl = document.getElementById('errorMessage');
          if (errorMessageEl) {
            errorMessageEl.textContent = `Failed to upload ${file.name}: ${error.message}`;
          }
          showModal('errorModal');
          throw error;
        }
      }

      return uploadedUrls;
    }

    const blogForm = document.getElementById('blogForm');
    const submitBtn = document.getElementById('submitBtn');
    const contentTextarea = document.getElementById('content');

    if (blogForm) {
      blogForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        

        if (quill && contentTextarea) {
          contentTextarea.value = quill.root.innerHTML;
        }

        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading Images...';
        }


        const linkItems = document.querySelectorAll('.link-item');
        let hasInvalidLink = false;
        
        linkItems.forEach(item => {
          const textInput = item.querySelector('.link-text-input');
          const urlInput = item.querySelector('.link-url-input');
          
          if (textInput && urlInput) {
            const hasText = textInput.value.trim() !== '';
            const hasUrl = urlInput.value.trim() !== '';
            
            if (hasText && !hasUrl) {
              urlInput.setCustomValidity('URL is required when link text is provided');
              urlInput.reportValidity();
              hasInvalidLink = true;
            } else if (hasUrl && !hasText) {
              textInput.setCustomValidity('Link text is required when URL is provided');
              textInput.reportValidity();
              hasInvalidLink = true;
            } else {
              textInput.setCustomValidity('');
              urlInput.setCustomValidity('');
            }
          }
        });
        
        if (hasInvalidLink) {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-<%= isEdit ? "save" : "plus" %>"></i> <%= isEdit ? "Update" : "Create" %> Blog';
          }
          return;
        }

        try {
          const uploadedUrls = await uploadAllImages();

          if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving Blog...';
          }


          const formData = new FormData();


          if (uploadedUrls.length > 0) {
            formData.append('uploaded_images', JSON.stringify(uploadedUrls));
          }


          const validLinks = [];
          linkItems.forEach((item, index) => {
            const textInput = item.querySelector('.link-text-input');
            const urlInput = item.querySelector('.link-url-input');
            
            if (textInput && urlInput) {
              const text = textInput.value.trim();
              const url = urlInput.value.trim();
              
              if (text && url) {
                formData.append(`links[${validLinks.length}][text]`, text);
                formData.append(`links[${validLinks.length}][url]`, url);
                validLinks.push({ text, url });
              }
            }
          });



          const existingImageInputs = blogForm.querySelectorAll('input[name="existing_images[]"]');
          const existingImagePaths = [];
          existingImageInputs.forEach(input => {

            if (input.value && input.value.trim() && input.offsetParent !== null) {
              existingImagePaths.push(input.value.trim());
            }
          });
          


          if (existingImagePaths.length > 0) {
            formData.append('existing_images_json', JSON.stringify(existingImagePaths));
          }


          const formElements = blogForm.elements;
          for (let element of formElements) {
            if (element.name && 
                element.name !== 'images' && 
                element.type !== 'file' && 
                element.name !== 'existing_images[]' &&
                !element.name.startsWith('links[')) {
              if (element.type === 'checkbox') {
                if (element.checked) {
                  formData.append(element.name, element.value);
                }
              } else if (element.type === 'radio') {
                if (element.checked) {
                  formData.append(element.name, element.value);
                }
              } else {
                formData.append(element.name, element.value);
              }
            }
          }


          const coverImageInput = document.getElementById('coverImageInput');
          let coverImageValue = coverImageInput ? coverImageInput.value : '';
          
          if (coverImageValue && coverImageValue.startsWith('new_image_index_')) {
            const originalIndex = parseInt(coverImageValue.replace('new_image_index_', ''));
            if (!isNaN(originalIndex) && uploadedUrls.length > 0) {


              let uploadedIndex = 0;
              let currentFileIndex = 0;
              
              for (let i = 0; i < imagesInput.files.length; i++) {
                if (!removedFileIndices.has(i)) {
                  if (i === originalIndex) {
                    break;
                  }
                  uploadedIndex++;
                }
              }
              
              if (uploadedIndex < uploadedUrls.length) {
                coverImageValue = uploadedUrls[uploadedIndex];
              } else {
                coverImageValue = uploadedUrls[0] || '';
              }
            } else {
              coverImageValue = uploadedUrls[0] || '';
            }
          }
          
          if (coverImageInput && coverImageInput.name) {
            formData.set('cover_image', coverImageValue);
          }


          const xhr = new XMLHttpRequest();

          xhr.addEventListener('load', function() {
            if (xhr.status >= 200 && xhr.status < 400) {
              const finalUrl = xhr.responseURL;
              if (finalUrl) {
                try {
                  const url = new URL(finalUrl);
                  window.location.href = url.pathname + url.search;
                } catch (e) {
                  const match = finalUrl.match(/https?:\/\/[^\/]+(\/.*)/);
                  if (match) {
                    window.location.href = match[1];
                  } else {
                    window.location.href = finalUrl;
                  }
                }
              } else {
                window.location.reload();
              }
            } else {
              const errorMessageEl = document.getElementById('errorMessage');
              if (errorMessageEl) {
                errorMessageEl.textContent = 'Error uploading blog. Please try again.';
              }
              showModal('errorModal');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-<%= isEdit ? "save" : "plus" %>"></i> <%= isEdit ? "Update" : "Create" %> Blog';
              }
            }
          });

          xhr.addEventListener('error', function() {
            const errorMessageEl = document.getElementById('errorMessage');
            if (errorMessageEl) {
              errorMessageEl.textContent = 'Network error. Please check your connection and try again.';
            }
            showModal('errorModal');
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i class="fas fa-<%= isEdit ? "save" : "plus" %>"></i> <%= isEdit ? "Update" : "Create" %> Blog';
            }
          });

          xhr.open('POST', blogForm.action);
          xhr.timeout = 300000;
          
          xhr.addEventListener('timeout', function() {
            const errorMessageEl = document.getElementById('errorMessage');
            if (errorMessageEl) {
              errorMessageEl.textContent = 'Upload timeout. The file may be too large or your connection is slow.';
            }
            showModal('errorModal');
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i class="fas fa-<%= isEdit ? "save" : "plus" %>"></i> <%= isEdit ? "Update" : "Create" %> Blog';
            }
          });
          
          xhr.send(formData);
        } catch (error) {
          console.error('Error during upload:', error);
          const errorMessageEl = document.getElementById('errorMessage');
          if (errorMessageEl) {
            errorMessageEl.textContent = `Upload failed: ${error.message}`;
          }
          showModal('errorModal');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-<%= isEdit ? "save" : "plus" %>"></i> <%= isEdit ? "Update" : "Create" %> Blog';
          }
        }
      });
    }
  </script>
</body>
</html>
